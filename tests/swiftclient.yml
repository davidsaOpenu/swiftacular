---
#
# SSL Testing
#

# If cert is ok, returns "ok", otherwise is not ok, ok?
#
# client$ echo QUIT | openssl s_client -showcerts -connect google.com:443 -showcerts -debug 2>&1 | grep "Verify return code"
#    Verify return code: 0 (ok)
# client$ echo QUIT | openssl s_client -showcerts -connect 192.168.100.50:35357 -showcerts -debug 2>&1 | grep "Verify return code"
#    Verify return code: 21 (unable to verify the first certificate)

- name: Verify ssl cert
  ansible.builtin.command: echo QUIT | openssl s_client -showcerts -connect 192.168.100.50:35357 2>&1 | grep "Verify return code"
  register: openssl_s_client

- name: Test for openssl client failed
  ansible.builtin.debug: msg="ssl client failed"
  when: openssl_s_client.stdout.find("ok") == -1

#
# [root@swift-keystone-01 ~]# curl --cacert /etc/keystone/ssl/certs/ca.pem https://192.168.100.50:35357
# curl: (51) SSL: certificate subject name 'localhost' does not match target host name '192.168.100.50'
#

#
#
#

- name: Check if adminrc exists
  ansible.builtin.stat: path=/home/vagrant/adminrc
- name: Run keystone user-list using adminrc file
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./adminrc; keystone --insecure user-list
- name: Check if testrc exists
  ansible.builtin.stat: path=/home/vagrant/testrc
- name: Run swift stat using testrc file
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./testrc; swift  stat
- name: Run swift list using testrc file
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./testrc; swift  list
- name: Create a file to upload
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" echo $RANDOM > swift.txt
- name: Get md5sum of uploaded file
  ansible.builtin.command: chdir=/home/vagrant md5sum swift.txt
  register: md5sum_upload

- name: Upload a file into swift
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./testrc; swift upload swifty swift.txt
- name: Remove swift.txt
  ansible.builtin.command: chdir=/home/vagrant rm -f ./swift.txt
- name: Download file again
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./testrc; swift download swifty swift.txt
- name: Get md5sum of downloaded file
  ansible.builtin.command: chdir=/home/vagrant md5sum swift.txt
  register: md5sum_download

- ansible.builtin.fail:
    msg: "md5sum for downloaded swift.txt file does not match uploaded md5sum"
  when: md5sum_download.stdout != md5sum_upload.stdout

# NOTE: This will delete all containers, files!
- name: Delete all from swifty container
  ansible.builtin.shell: chdir=/home/vagrant executable="/bin/bash" source ./testrc; swift delete --all
- name: Remove swift.txt
  ansible.builtin.command: chdir=/home/vagrant rm -f ./swift.txt
